<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inspection PDF Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height:100%; }
    body { margin:0; background:#0b0b0c; }
    .toolbar { position:sticky; top:0; z-index:50; }
  </style>

  <!-- Keep: capture PDF blobs created on this page (best-effort) -->
  <script>
  (function(){
    // Keep a weak in-memory cache for transient blobs, so if the user clicks "Save a copy"
    // after the iframe has navigated elsewhere we can still re-provide the last blob.
    window.__pdfBlobs = window.__pdfBlobs || new Map();
    window.__rememberPdfBlob = (key, blob) => {
      try { if (key && blob) window.__pdfBlobs.set(key, blob); } catch {}
    };
    window.__getPdfBlob = (key) => {
      try { return key ? window.__pdfBlobs.get(key) : null; } catch { return null; }
    };
  })();
  </script>
</head>
<body class="text-white">
  <!-- Toolbar -->
  <header class="toolbar w-full bg-black/60 backdrop-blur supports-[backdrop-filter]:bg-black/40 border-b border-white/10">
    <div class="max-w-screen-xl mx-auto px-4 py-2 flex items-center gap-2">
      <a href="/" class="text-sm text-white/70 hover:text-white">‚Üê Back</a>
      <div class="ml-auto flex items-center gap-2">
        <button id="btnSave" class="px-3 py-1.5 rounded bg-white/10 hover:bg-white/20 text-sm">Save a copy</button>
        <button id="btnFleetio" class="px-3 py-1.5 rounded bg-emerald-600 hover:bg-emerald-500 text-sm">Create Fleetio Work Order</button>
        <button id="btnClose" class="px-3 py-1.5 rounded bg-white/10 hover:bg-white/20 text-sm">Close</button>
      </div>
    </div>
  </header>

  <!-- PDF frame -->
  <main class="max-w-screen-xl mx-auto px-4 py-4 h-[calc(100%-48px)]">
    <iframe id="pdf" class="w-full h-full rounded-lg border border-white/10 bg-black" src=""></iframe>
  </main>

  <script>
  (function(){
    const qs = new URLSearchParams(location.search);
    const src = qs.get('src') || '';
    const filename = qs.get('filename') || 'Schedule-4_Inspection.pdf';
    const blobKey = qs.get('id') || qs.get('recordId') || 'default';

    // show PDF
    const iframe = document.getElementById('pdf');
    if (src) {
      iframe.src = src;
    } else {
      // Fallback: black page if no src
      iframe.srcdoc = '<style>html,body{height:100%;margin:0;background:#000;color:#fff;display:grid;place-items:center;font-family:system-ui}</style><div>No PDF source was provided.</div>';
    }

    // save a copy
    document.getElementById('btnSave').addEventListener('click', async () => {
      try {
        let blob;
        if (src.startsWith('blob:')) {
          // If the blob came from this process, try retrieve it
          blob = window.__getPdfBlob(blobKey);
          if (!blob) {
            // fetch the blob from the blob URL
            const r = await fetch(src);
            blob = await r.blob();
          }
        } else {
          // Remote URL; just fetch the bytes
          const r = await fetch(src, { credentials: 'omit' });
          blob = await r.blob();
        }

        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(a.href), 1500);
      } catch (e) {
        alert('Failed to save PDF: ' + (e?.message || e));
      }
    });

    document.getElementById('btnClose').addEventListener('click', () => window.close());
  })();
  </script>

  <!-- Viewer context: parse query params and expose for Fleetio -->
  <script>
    (function(){
      try {
        const q = new URLSearchParams(location.search);
        const id = q.get('id') || q.get('recordId') || q.get('inspectionId') || '';
        const meta = {
          unit: q.get('unit') || '',
          odometer: q.get('odometer') || '',
          date: q.get('date') || '',
          filename: q.get('filename') || ''
        };
        // Expose globals for /js/fleetio.js
        window.schedule4InspectionId = id;
        window.schedule4Meta = meta;
        // For sanity/debugging:
        // console.debug('[viewer] schedule4InspectionId:', id, meta);
      } catch(e) {
        // no-op
      }
    })();
  </script>

  <!-- Single, authoritative Fleetio handler -->
  <script src="/js/fleetio.js"></script>
</body>
</html>
