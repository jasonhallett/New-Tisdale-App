<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PDF Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height: 100%; }
    body { margin: 0; background: #0b1020; color: #fff; }
    .toolbar { position: sticky; top: 0; z-index: 10; background: #0b1020; border-bottom: 1px solid #1e293b; }
    .btn {
      background: #111827; color: #fff; border: 1px solid #1f2937; padding: 8px 12px; border-radius: 8px;
      font-weight: 500; font-size: 14px; cursor: pointer; transition: transform .04s ease;
    }
    .btn:hover { background: #1f2937; }
    .btn:active { transform: translateY(1px); }
    .btn[disabled] { opacity:.5; cursor:not-allowed; }
    iframe, embed { width: 100%; height: calc(100dvh - 56px); background: #1f2937; border: 0; }
    .badge { font-size: 12px; opacity: .8; }
  </style>
</head>
<body>
  <div class="toolbar w-full">
    <div class="max-w-screen-2xl mx-auto px-3 py-2 flex items-center gap-2">
      <button id="btnPrint" class="btn">Print</button>
      <button id="btnDownload" class="btn">Save to Files</button>
      <button id="btnImport" class="btn" disabled title="Coming soon">Import to Fleetio Work Order</button>
      <div class="flex-1"></div>
      <span id="fileMeta" class="badge"></span>
      <button id="btnClose" class="btn">Close</button>
    </div>
  </div>

  <!-- We use <iframe>. If your environment renders better with <embed>, swap the tag below. -->
  <iframe id="pdfFrame" src="" title="PDF"></iframe>

  <script>
    (function () {
      const qs = new URLSearchParams(location.search);
      const src = qs.get("src");                 // expected to be a blob: URL or data:application/pdf
      const filename = qs.get("filename") || "document.pdf";
      const inspectionId = qs.get("id") || "";   // not required for save/print; just metadata

      const frame = document.getElementById("pdfFrame");
      const meta = document.getElementById("fileMeta");
      const btnPrint = document.getElementById("btnPrint");
      const btnDownload = document.getElementById("btnDownload");
      const btnClose = document.getElementById("btnClose");
      const btnImport = document.getElementById("btnImport");

      // Initialize
      if (!src) {
        document.body.innerHTML =
          '<div class="p-6 text-center text-red-300">Missing <code>?src=</code> for PDF viewer.</div>';
        return;
      }
      // Load the exact PDF we already have (no server regeneration)
      frame.src = src;
      meta.textContent = (inspectionId ? `ID: ${inspectionId} Â· ` : "") + filename;

      // --- SAVE the currently open PDF ---
      btnDownload.addEventListener("click", async () => {
        try {
          // If src is blob: or data: we can download directly via <a download>
          // Otherwise (http/https), fetch it first and re-blob it.
          if (src.startsWith("blob:") || src.startsWith("data:application/pdf")) {
            const a = document.createElement("a");
            a.href = src;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
          } else {
            const resp = await fetch(src, { credentials: "include" });
            if (!resp.ok) throw new Error(`Download failed (${resp.status})`);
            const blob = await resp.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url; a.download = filename;
            document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
          }
        } catch (err) {
          alert("Could not save this PDF: " + (err && err.message ? err.message : err));
        }
      });

      // --- PRINT the currently open PDF ---
      btnPrint.addEventListener("click", () => {
        try {
          // Best effort: print the embedded PDF viewer.
          if (frame && frame.contentWindow) {
            frame.contentWindow.focus();
            frame.contentWindow.print();
          } else {
            // Fallback: open a new tab with the src and invoke print (some browsers block this)
            const w = window.open(src, "_blank", "noopener");
            if (w) w.addEventListener("load", () => w.print());
          }
        } catch (err) {
          alert("Could not trigger print: " + (err && err.message ? err.message : err));
        }
      });

      // --- IMPORT placeholder ---
      btnImport.addEventListener("click", () => {
        alert("Fleetio Work Order import is coming soon. We will use this open PDF as the source payload.");
      });

      // --- CLOSE ---
      btnClose.addEventListener("click", () => {
        try { window.close(); } catch(_) {}
      });

      // Defensive: warn if someone tries to navigate away
      window.addEventListener("beforeunload", (e) => {
        // no-op; add e.preventDefault() if you want to warn
      });
    })();
  </script>
</body>
</html>
