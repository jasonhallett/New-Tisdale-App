<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TBL Internal App - View Schedule 4 Inspection</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    html, body { margin:0; padding:0; background:#ffffff; font-family:'Inter',sans-serif; }
    :root { --page-w: 816px; --page-h: 1056px; }

    #page { width: var(--page-w); min-height: var(--page-h); margin: 0 auto; background: #ffffff; }
    .content { padding: 12px; }

    .section-header { font-size: 0.75rem; font-weight: 600; color: #1f2937; margin-bottom: 0.25rem; }
    .form-group label { font-weight: 500; color: #374151; font-size: 0.625rem; }
    .output-text { width: 100%; padding: 0.2rem 0.4rem; border-radius: 6px; border: 1px solid #d1d5db; font-size: 0.625rem; background-color: #f9fafb; color: #1f2937; flex: 1; }

    .checklist-item { display: flex; align-items: center; background-color: #f9fafb; padding: 0.025rem; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 0.025rem; }
    .checklist-item-text { font-size: 0.625rem; color: #374151; }
    .checklist-status { font-weight: 600; font-size: 0.625rem; padding: 0.1rem 0.6rem; border-radius: 4px; margin-right: 0.25rem; }
    .status-pass { color: #166534; background-color: #dcfce7; }
    .status-repair { color: #991b1b; background-color: #fee2e2; }
    .status-na { color: #4b5563; background-color: #e5e7eb; }

    .text-xxs { font-size: 0.5rem; }
    .signature-img { width: 400px; height: 100px; border: 1px solid #e5e7eb; object-fit: contain; }

    @page { size: 8.5in 11in; margin: 0; }
    @media print {
      html, body { width:8.5in; height:11in; margin:0; padding:0; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
      #page { width:8.5in !important; min-height:11in !important; margin:0 !important; }
      .no-print { display:none !important; }
    }

    @media (max-width: 640px){
      .always-two-col{ grid-template-columns: repeat(2, minmax(0, 1fr)) !important; }
    }

    /* Hide stray page counters like "/1" */
    body::before, body::after, html::before, html::after, #page::before, #page::after, .page::before, .page::after { content: none !important; display: none !important; }
    .page-number, .pageNumber, [data-page-number] { display: none !important; }

    @media print {
      .page, #page { page-break-after: auto !important; break-after: auto !important; }
      .page:last-child, #page:last-child { page-break-after: avoid !important; break-after: avoid-page !important; }
    }

    /* Desktop print: scale to 95% and center */
    @media print {
      #page { transform: translate(0.2125in, 0.275in) scale(0.95) !important; transform-origin: top left !important; }
    }

    /* iPhone/iPad Safari nudge */
    @media print {
      @supports (-webkit-touch-callout: none) {
        #page { transform: translate(0.28in, 0.40in) scale(0.90) !important; transform-origin: top left !important; }
      }
    }
  </style>
</head>
<body>
  <!-- Top-right action buttons (hidden in print) -->
  <div class="no-print" style="position:fixed;top:10px;right:10px;z-index:999;display:flex;gap:8px;">
    <button onclick="window.print()"
            style="background:#111827;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;">
      Print
    </button>
    <button id="btnDownload"
            style="background:#2563eb;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;">
      Download (PDF)
    </button>
  </div>

  <!-- Loading / error area (hidden once ready) -->
  <div id="status" class="no-print" style="position:fixed;left:50%;top:18px;transform:translateX(-50%);z-index:999;background:#0f172a;color:#fff;padding:8px 12px;border-radius:8px;border:1px solid #ffffff22;display:none;"></div>

  <!-- Page -->
  <div id="page" aria-busy="true">
    <div class="content" id="pdf-root">
      <h1 class="text-xs font-bold text-center text-gray-800 mb-3">Schedule 4 Motor Coach Under-Vehicle Inspection Report</h1>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-1 mb-1">
        <div class="form-group"><label>Carrier</label><div class="output-text" data-field="carrierName"></div></div>
        <div class="form-group"><label>Address of the location where the inspection is conducted</label><div class="output-text" data-field="locationAddress"></div></div>
      </div>

      <div class="grid grid-cols-2 sm:grid-cols-4 gap-1 mb-1">
        <div class="form-group flex items-center"><label>Unit #</label><div class="output-text" data-field="unitNumber"></div></div>
        <div class="form-group flex items-center"><label>Licence Plate</label><div class="output-text" data-field="licensePlate"></div></div>
        <div class="form-group flex items-center"><label>Odometer (km)</label><div class="output-text" data-field="odometer"></div></div>
        <div class="form-group flex items-center"><label>Date Inspected</label><div class="output-text" data-field="inspectionDate"></div></div>
      </div>

      <div class="grid grid-cols-2 sm:grid-cols-4 gap-1 mb-1">
        <p class="text-xxs text-gray-500 italic col-span-2">
          An under-vehicle inspection is valid until the 31st day after it is conducted or until the motor coach has been driven 12,000 kilometres, whichever occurs last.
        </p>
        <div class="form-group flex items-center"><label>Odometer Expires</label><div class="output-text" data-field="odometerExpires"></div></div>
        <div class="form-group flex items-center"><label>Date Expires</label><div class="output-text" data-field="dateExpires"></div></div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 always-two-col">
        <!-- Left column -->
        <div>
          <h2 class="section-header my-1">1. Air Brake System</h2>
          <div class="grid grid-cols-1 gap-0.5">
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Audible air leak</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Brake pushrod stroke is at or beyond the adjustment limit</span></div>
            <div class="pl-4 mt-1">
              <h3 class="font-bold my-1 text-gray-800 text-xxs">Brake Pushrod Stroke Measurements</h3>
              <div class="flex flex-wrap gap-2">
                <div class="flex items-center"><label class="mr-1 text-xxs">R Steer</label><div class="output-text" style="width:45px;" data-field="rSteerBrake"></div></div>
                <div class="flex items-center"><label class="mr-1 text-xxs">R Drive</label><div class="output-text" style="width:45px;" data-field="rDriveBrake"></div></div>
                <div class="flex items-center"><label class="mr-1 text-xxs">R Tag</label><div class="output-text" style="width:45px;" data-field="rTagBrake"></div></div>
              </div>
              <div class="flex flex-wrap gap-2 mt-1">
                <div class="flex items-center"><label class="mr-1 text-xxs">L Steer</label><div class="output-text" style="width:45px;" data-field="lSteerBrake"></div></div>
                <div class="flex items-center"><label class="mr-1 text-xxs">L Drive</label><div class="output-text" style="width:45px;" data-field="lDriveBrake"></div></div>
                <div class="flex items-center"><label class="mr-1 text-xxs">L Tag</label><div class="output-text" style="width:45px;" data-field="lTagBrake"></div></div>
              </div>
            </div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Clearance between disc brake pads and rotor exceeds manufacturer's specified limit</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Wedge brake shoe movement exceeds manufacturer's specified limit</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Excessive discharge of fluids from air reservoir</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Air compressor, mounts or attachments damaged or defective</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Compressor drive belt loose or damaged</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Air line or fitting damaged or insecure</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Air tank defective, damaged or insecure</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Air tank drain or moisture ejector device inoperative</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Brake chamber, brake linkage or other brake component is defective, damaged or insecure</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Spring brake is broken or malfunctions</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Inoperative service, parking or emergency brake</span></div>
          </div>

          <h2 class="section-header my-1">2. Exhaust System</h2>
          <div class="grid grid-cols-1 gap-0.5">
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Exhaust leak</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Exhaust system component insecure, damaged or perforated</span></div>
          </div>

          <h2 class="section-header my-1">3. Frame and/or Underbody</h2>
          <div class="grid grid-cols-1 gap-0.5">
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Any frame member or fastener is damaged, cracked or insecure</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Any component mount is damaged or insecure</span></div>
          </div>
        </div>

        <!-- Right column -->
        <div>
          <h2 class="section-header my-1">4. Fuel System</h2>
          <div class="grid grid-cols-1 gap-0.5">
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Fuel leak</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Insecure fuel tanks, fuel tank mounts or guards</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Fuel line or fitting damaged or insecure</span></div>
          </div>

          <h2 class="section-header my-1">5. Steering</h2>
          <div class="grid grid-cols-1 gap-0.5">
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Steering linkage is damaged or insecure</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Power steering fluid is leaking, contaminated or low</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Power steering component damaged or insecure</span></div>
          </div>

          <h2 class="section-header my-1">6. Suspension System</h2>
          <div class="grid grid-cols-1 gap-0.5">
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Air leak or malfunction of air suspension system or component</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Damage or deterioration of any suspension component</span></div>
          </div>

          <h2 class="section-header my-1">7. Tires</h2>
          <div class="grid grid-cols-1 gap-0.5">
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Tire inflation less than required</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Tire treads worn to wear limits</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Damage to tread or sidewall of tire</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Retread or rebuilt tire is used on front axle</span></div>
          </div>

          <h2 class="section-header my-1">8. Wheels and Fasteners</h2>
          <div class="grid grid-cols-1 gap-0.5">
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Loose, missing, damaged or ineffective wheel fastener</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Damaged wheel or wheel component</span></div>
          </div>

          <h2 class="section-header my-1">For buses travelling to USA, per FMCSA Regulations, Part 396.3</h2>
          <div class="grid grid-cols-1 gap-0.5">
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">All push-out windows, emergency doors, and emergency door marking lights inspected and found to be operating normally</span></div>
            <div class="form-group flex items-center"><label>Tire size:</label><div class="output-text" data-field="tireSize"></div></div>
          </div>
        </div>
      </div>

      <div class="mt-2">
        <h2 class="section-header my-1">Repairs</h2>
        <div class="output-text" data-field="repairs"></div>
      </div>

      <div class="mt-2 grid grid-cols-2 gap-1">
        <div class="form-group">
          <h2 class="section-header my-1">Name of the person who conducted the inspection (Printed)</h2>
          <div class="output-text" data-field="inspectorName"></div>
          <div class="text-xxs text-gray-700 leading-tight mt-1">
            I declare that the vehicle shown above has been inspected in accordance with this Regulation and that at the end of the inspection, there are no defects listed in Schedule 4. O. Reg. 199/07, s. 12 (1); O. Reg. 242/14, s. 6 (1-3); O. Reg. 256/15, s. 5 (1).
          </div>
        </div>
        <div class="form-group">
          <h2 class="section-header my-1">Signature of the person who conducted the inspection</h2>
          <div class="output-text p-1" style="height:100px;">
            <img id="signatureImg" alt="Signature" class="mx-auto block signature-img">
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Helpers ----------
    function toUSDateString(input) {
      if (!input) return '';
      if (typeof input === 'string') {
        var m = input.match(/^(\d{4})-(\d{2})-(\d{2})/); // yyyy-mm-dd
        if (m) return m[2] + '/' + m[3] + '/' + m[1];
        var mmdd = input.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/); // mm/dd/yyyy
        if (mmdd) return mmdd[1].padStart(2,'0') + '/' + mmdd[2].padStart(2,'0') + '/' + mmdd[3];
      }
      var d = new Date(input);
      if (!isNaN(d)) return String(d.getMonth()+1).padStart(2,'0') + '/' + String(d.getDate()).padStart(2,'0') + '/' + d.getFullYear();
      return '';
    }
    function fmtKM(val) {
      if (val == null || val === '') return '';
      const n = typeof val === 'number' ? val : parseInt(String(val).replace(/,/g, ''), 10);
      if (Number.isNaN(n)) return String(val);
      return n.toLocaleString('en-US');
    }
    function normalizeLabel(s){
      return String(s||'')
        .toLowerCase()
        .replace(/&amp;|&&|&/g, 'and')
        .replace(/\band\/or\b/g,'and or')
        .replace(/[^a-z0-9]+/g,' ')
        .replace(/\s+/g,' ')
        .trim();
    }
    function renderError(msg) {
      const status = document.getElementById('status');
      status.textContent = msg;
      status.style.display = 'block';
      document.title = 'Error – Schedule 4';
      window.__REPORT_ERROR = msg;
      // Replace page with a printable error state
      const page = document.getElementById('page');
      page.innerHTML = `
        <div class="content">
          <h1 class="text-base font-bold text-red-700 mb-2">Unable to render report</h1>
          <div class="text-sm text-gray-800">${msg.replace(/</g,'&lt;')}</div>
        </div>
      `;
      page.setAttribute('aria-busy', 'false');
      window.__REPORT_READY = true;
    }

    // ---------- Load from DB by id (DB-ONLY) ----------
    (async function init() {
      const params = new URLSearchParams(location.search);
      const id = params.get('id') || params.get('inspectionId') || params.get('schedule4Id');
      if (!id) {
        renderError('Missing inspection id. Add ?id= to the URL.');
        return;
      }

      const status = document.getElementById('status');
      status.textContent = 'Loading...';
      status.style.display = 'block';

      try {
        const res = await fetch('/api/schedule4s/get?id=' + encodeURIComponent(id), { headers: { 'Accept':'application/json' } });
        if (!res.ok) {
          if (res.status === 404) { renderError('Inspection not found for id "'+id+'".'); return; }
          const t = await res.text().catch(()=>String(res.status));
          renderError('Failed to load inspection (' + res.status + '): ' + t);
          return;
        }
        const resp = await res.json().catch(()=> ({}));
        const row = resp.item || resp || {};
        const p = row.payload_json || row.payload || {};

        function pick() {
          for (var i = 0; i < arguments.length; i++) {
            var k = arguments[i];
            if (p && p[k] != null && p[k] !== '') return p[k];
          }
          return '';
        }

        const data = {
          carrierName:     pick('carrierName','carrier'),
          locationAddress: pick('locationAddress','address','inspectionLocation'),
          unitNumber:      pick('unitNumber','unit','vehicle_number') || row.vehicle_name || '',
          licensePlate:    pick('licensePlate','licencePlate','plate'),
          odometer:        pick('odometer','odometerKm','odometer_km'),
          inspectionDate:  pick('inspectionDate') || row.performed_at || row.created_at || '',
          odometerExpires: pick('odometerExpires'),
          dateExpires:     pick('dateExpires') || row.expiry_date || '',
          tireSize:        pick('tireSize'),
          repairs:         pick('repairs','repairsNotes','repairs_text'),
          inspectorName:   pick('inspectorName') || row.technician_name || '',
          rSteerBrake: pick('rSteerBrake'),
          rDriveBrake: pick('rDriveBrake'),
          rTagBrake:   pick('rTagBrake'),
          lSteerBrake: pick('lSteerBrake'),
          lDriveBrake: pick('lDriveBrake'),
          lTagBrake:   pick('lTagBrake'),
          signature:       pick('signature'),
          checklist:       p.checklist || {}
        };

        // Normalize dates for display
        data.inspectionDate = toUSDateString(data.inspectionDate);
        data.dateExpires = toUSDateString(data.dateExpires) || (data.inspectionDate ? toUSDateString(new Date(new Date(data.inspectionDate).getTime()+31*864e5)) : '');
        // Fill simple fields
        document.querySelector('[data-field="carrierName"]').textContent = data.carrierName || '';
        document.querySelector('[data-field="locationAddress"]').textContent = data.locationAddress || '';
        document.querySelector('[data-field="unitNumber"]').textContent = data.unitNumber || '';
        document.querySelector('[data-field="licensePlate"]').textContent = data.licensePlate || '';
        document.querySelector('[data-field="odometer"]').textContent = fmtKM(data.odometer);
        document.querySelector('[data-field="inspectionDate"]').textContent = data.inspectionDate || '';
        document.querySelector('[data-field="odometerExpires"]').textContent = fmtKM(data.odometerExpires);
        document.querySelector('[data-field="dateExpires"]').textContent = data.dateExpires || '';
        document.querySelector('[data-field="tireSize"]').textContent = data.tireSize || '';
        document.querySelector('[data-field="repairs"]').textContent = data.repairs || '';
        if (data.inspectorName) document.querySelector('[data-field="inspectorName"]').textContent = data.inspectorName;
        if (data.signature) document.getElementById('signatureImg').src = data.signature;

        // Checklist
        const dataChecklistNorm = {};
        Object.keys(data.checklist || {}).forEach(function(k){
          dataChecklistNorm[normalizeLabel(k)] = data.checklist[k];
        });
        function setStatus(el, status) {
          if (!status) return;
          const badge = el.querySelector('.checklist-status'); if (!badge) return;
          badge.className = 'checklist-status';
          const s = String(status||'').toLowerCase();
          if (['pass','ok','✓','yes','y','true'].includes(s)) { badge.textContent='✓'; badge.classList.add('status-pass'); }
          else if (['repair','repaired','r','fail','f','false'].includes(s)) { badge.textContent='R'; badge.classList.add('status-repair'); }
          else if (['na','n/a','not applicable'].includes(s)) { badge.textContent='N/A'; badge.classList.add('status-na'); }
        }
        Array.prototype.slice.call(document.querySelectorAll('.checklist-item')).forEach(function(item){
          const labelTxt = (item.querySelector('.checklist-item-text') || {}).textContent || '';
          const norm = normalizeLabel(labelTxt);
          let st = dataChecklistNorm[norm];
          if (!st) {
            // light fuzzy: longest included key
            let bestKey = '';
            for (const k in dataChecklistNorm) { if (norm.indexOf(k) !== -1 && k.length > bestKey.length) bestKey = k; }
            if (bestKey) st = dataChecklistNorm[bestKey];
          }
          setStatus(item, st);
        });

        // Expose for filename and server print
        window.__schedule4_getData = function(){ return data; };
        window.__schedule4_toUS = toUSDateString;

        // Ready
        document.getElementById('page').setAttribute('aria-busy','false');
        status.style.display = 'none';
        window.__REPORT_READY = true;
      } catch (err) {
        renderError('Error loading inspection: ' + (err && err.message ? err.message : String(err)));
      }
    })();

    // ---------- Server PDF download (uses current id) ----------
    document.getElementById('btnDownload').addEventListener('click', async () => {
      try {
        const data = (window.__schedule4_getData && window.__schedule4_getData()) || {};
        const unitRaw = (data.unitNumber || 'Unit').toString().trim();
        const unitSan = unitRaw.replace(/[\/\\<>:"|?*]+/g,'').trim(); // keep spaces and #
        const toUS = (window.__schedule4_toUS || function(x){ return x; });
        const dateUS = toUS(data.inspectionDate) || toUS(new Date());
        const dateForFile = String(dateUS || '').replace(/\//g,'-'); // mm-dd-yyyy
        const filename = `Schedule4-${unitSan}-${dateForFile}.pdf`;

        const params = new URLSearchParams(location.search);
        const id = params.get('id') || params.get('inspectionId') || params.get('schedule4Id');
        if (!id) throw new Error('Missing inspection id, cannot print.');

        const res = await fetch('/api/pdf/print', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path: `/output.html?id=${encodeURIComponent(id)}`, data, filename })
        });
        if (!res.ok) throw new Error(await res.text());
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        alert('Server PDF failed: ' + err.message);
      }
    });
  </script>
</body>
</html>
