<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Completed Motor Coach Under-Vehicle Inspection Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    html, body { margin:0; padding:0; background:#ffffff; font-family:'Inter',sans-serif; }
    :root { --page-w: 816px; --page-h: 1056px; }
    #page { width: var(--page-w); min-height: var(--page-h); margin: 0 auto; background: #ffffff; }
    .content { padding: 12px; }
    .section-header { font-size: 0.75rem; font-weight: 600; color: #1f2937; margin-bottom: 0.25rem; }
    .form-group label { font-weight: 500; color: #374151; font-size: 0.625rem; }
    .output-text { width: 100%; padding: 0.2rem 0.4rem; border-radius: 6px; border: 1px solid #d1d5db; font-size: 0.625rem; background-color: #f9fafb; color: #1f2937; flex: 1; }
    .checklist-item { display: flex; align-items: center; background-color: #f9fafb; padding: 0.025rem; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 0.025rem; }
    .checklist-item-text { font-size: 0.625rem; color: #374151; }
    .checklist-status { font-weight: 600; font-size: 0.625rem; padding: 0.1rem 0.6rem; border-radius: 4px; margin-right: 0.25rem; }
    .status-pass { color: #166534; background-color: #dcfce7; }
    .status-repair { color: #991b1b; background-color: #fee2e2; }
    .status-na { color: #4b5563; background-color: #e5e7eb; }
    .text-xxs { font-size: 0.5rem; }
    .signature-img { max-width: 300px; height: auto; border: 1px solid #e5e7eb; }
    @page { size: 8.5in 11in; margin: 0; }
    @media print {
      html, body { width:8.5in; height:11in; margin:0; padding:0; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
      #page { width:8.5in !important; min-height:11in !important; margin:0 !important; }
      .no-print { display:none !important; }
    }
  </style>
</head>
<body>
  <div class="no-print" style="position:fixed;top:10px;right:10px;z-index:999;display:flex;gap:8px;">
    <button onclick="window.print()" style="background:#111827;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;">
      Download PDF
    </button>
    <!-- === Puppeteer Server PDF START === -->
    <button onclick="downloadServerPDF()" style="background:#2563eb;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;">
      Download (Server PDF)
    </button>
    <!-- === Puppeteer Server PDF END === -->
  </div>

  <div id="page">
    <div class="content" id="pdf-root">
      <!-- === Full form remains unchanged (Carrier, Address, Unit, Plate, Odometer, Date, Checklists, Repairs, Inspector, Signature) === -->
    </div>
  </div>

  <script>
    (function () {
      function getData() {
        let data = {};
        try { const ss = sessionStorage.getItem('schedule4Data'); if (ss) data = JSON.parse(ss) || {}; } catch(e){}
        const params = new URLSearchParams(location.search);
        const keys = [
          'carrierName','locationAddress','unitNumber','licensePlate','odometer','inspectionDate',
          'odometerExpires','dateExpires','rSteerBrake','rDriveBrake','rTagBrake','lSteerBrake','lDriveBrake','lTagBrake',
          'tireSize','repairs','inspectorName','signature'
        ];
        for (const k of keys) if (!(k in data) && params.has(k)) data[k] = params.get(k);
        data.checklist = data.checklist || {};
        return data;
      }
      const data = getData();
      function fillByLabel(labelText, value) {
        if (!value) return;
        const labels = [...document.querySelectorAll('label')];
        const label = labels.find(l => l.textContent.trim().toLowerCase() === labelText.toLowerCase());
        if (label) {
          const box = label.closest('.form-group,.flex')?.querySelector('.output-text');
          if (box) box.textContent = value;
        }
      }
      fillByLabel('Carrier', data.carrierName);
      fillByLabel('Address of the location where the inspection is conducted', data.locationAddress);
      fillByLabel('Unit #', data.unitNumber);
      fillByLabel('Licence Plate', data.licensePlate);
      fillByLabel('Odometer (km)', data.odometer);
      fillByLabel('Date', data.inspectionDate);
      fillByLabel('Odometer Expires', data.odometerExpires);
      fillByLabel('Date Expires', data.dateExpires);
      fillByLabel('Tire size:', data.tireSize);
      function fillTiny(lbl, val) {
        if (!val) return;
        const tiny = [...document.querySelectorAll('.pl-4 .flex.items-center')];
        const match = tiny.find(g => g.querySelector('label')?.textContent.trim().toLowerCase() === lbl.toLowerCase());
        const box = match?.querySelector('.output-text');
        if (box) box.textContent = val;
      }
      fillTiny('r steer', data.rSteerBrake);
      fillTiny('r drive', data.rDriveBrake);
      fillTiny('r tag', data.rTagBrake);
      fillTiny('l steer', data.lSteerBrake);
      fillTiny('l drive', data.lDriveBrake);
      fillTiny('l tag', data.lTagBrake);
      const repHdr = [...document.querySelectorAll('.section-header')].find(h=>h.textContent.trim().toLowerCase()==='repairs');
      if (repHdr) { const box = repHdr.parentElement.querySelector('.output-text'); if (box && data.repairs) box.textContent = data.repairs; }
      const inspHdr = [...document.querySelectorAll('.section-header')].find(h=>h.textContent.toLowerCase().includes('name of the person'));
      if (inspHdr) { const box = inspHdr.parentElement.querySelector('.output-text'); if (box && data.inspectorName) box.textContent = data.inspectorName; }
      if (data.signature) { const img = document.getElementById('signatureImg'); if (img) img.src = data.signature; }
      function setStatus(el, status) {
        const badge = el.querySelector('.checklist-status'); if (!badge) return;
        badge.className = 'checklist-status';
        if (['pass','ok','✓','yes','y'].includes((status||'').toLowerCase())) { badge.textContent='✓'; badge.classList.add('status-pass'); }
        else if (['repair','repaired','r','fail','f'].includes((status||'').toLowerCase())) { badge.textContent='R'; badge.classList.add('status-repair'); }
        else if (['na','n/a','not applicable'].includes((status||'').toLowerCase())) { badge.textContent='N/A'; badge.classList.add('status-na'); }
      }
      document.querySelectorAll('.checklist-item').forEach(item => {
        const label = item.querySelector('.checklist-item-text')?.textContent.trim();
        if (label && data.checklist[label]) setStatus(item, data.checklist[label]);
      });
    })();

    // === Puppeteer Server PDF START ===
    async function downloadServerPDF() {
      try {
        const data = JSON.parse(sessionStorage.getItem('schedule4Data') || '{}');
        const res = await fetch('/api/pdf/print', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path: '/output.html', data, filename: 'Schedule-4-Inspection.pdf' })
        });
        if (!res.ok) throw new Error(await res.text());
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'Schedule-4-Inspection.pdf';
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      } catch (err) { alert('Server PDF failed: ' + err.message); }
    }
    // === Puppeteer Server PDF END ===
  </script>
</body>
</html>