<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TBL Internal App - View Schedule 4 Inspection</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    html, body { margin:0; padding:0; background:#ffffff; font-family:'Inter',sans-serif; }
    :root { --page-w: 816px; --page-h: 1056px; }

    #page { width: var(--page-w); min-height: var(--page-h); margin: 0 auto; background: #ffffff; }
    .content { padding: 12px; }

    .section-header { font-size: 0.75rem; font-weight: 600; color: #1f2937; margin-bottom: 0.25rem; }
    .form-group label { font-weight: 500; color: #374151; font-size: 0.625rem; }
    .output-text { width: 100%; padding: 0.2rem 0.4rem; border-radius: 6px; border: 1px solid #d1d5db; font-size: 0.625rem; background-color: #f9fafb; color: #1f2937; flex: 1; }

    .checklist-item { display: flex; align-items: center; background-color: #f9fafb; padding: 0.025rem; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 0.025rem; }
    .checklist-item-text { font-size: 0.625rem; color: #374151; }
    .checklist-status { font-weight: 600; font-size: 0.625rem; padding: 0.1rem 0.6rem; border-radius: 4px; margin-right: 0.25rem; }
    .status-pass { color: #166534; background-color: #dcfce7; }
    .status-repair { color: #991b1b; background-color: #fee2e2; }
    .status-na { color: #4b5563; background-color: #e5e7eb; }

    .text-xxs { font-size: 0.5rem; }
    .signature-img { width: 400px; height: 100px; border: 1px solid #e5e7eb; object-fit: contain; }

    @page { size: 8.5in 11in; margin: 0; }
    @media print {
      html, body { width:8.5in; height:11in; margin:0; padding:0; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
      #page { width:8.5in !important; min-height:11in !important; margin:0 !important; }
    }
  </style>

  <style id="single-page-fix">
  body::before, body::after, html::before, html::after,
  #page::before, #page::after, .page::before, .page::after { content: none !important; display: none !important; }
  .page-number, .pageNumber, [data-page-number] { display: none !important; }

  @media print {
    .page, #page { page-break-after: auto !important; break-after: auto !important; }
    .page:last-child, #page:last-child { page-break-after: avoid !important; break-after: avoid-page !important; }
  }
  </style>

  <style id="print-scale-95">
    @media print {
      .no-print { display: none !important; }
      #page {
        transform: translate(0.2125in, 0.275in) scale(0.95) !important;
        transform-origin: top left !important;
      }
    }
  </style>

</head>
<body>
  <!-- Buttons -->
  <div class="no-print" style="position:fixed;top:10px;right:10px;z-index:999;display:flex;gap:8px;">
    <button onclick="window.print()"
            style="background:#111827;color:#fff;border:none;
                   padding:8px 12px;border-radius:6px;cursor:pointer;">
      Print
    </button>
    <button onclick="downloadServerPDF"
            style="background:#2563eb;color:#fff;border:none;
                   padding:8px 12px;border-radius:6px;cursor:pointer;">
      Download (PDF)
    </button>
  </div>

  <!-- Page -->
  <div id="page">
    <div class="content" id="pdf-root">
      <h1 class="text-xs font-bold text-center text-gray-800 mb-3">Schedule 4 Motor Coach Under-Vehicle Inspection Report</h1>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-1 mb-1">
        <div class="form-group"><label>Carrier</label><div class="output-text"></div></div>
        <div class="form-group"><label>Address of the location where the inspection is conducted</label><div class="output-text"></div></div>
      </div>

      <div class="grid grid-cols-2 sm:grid-cols-4 gap-1 mb-1">
        <div class="form-group flex items-center"><label>Unit #</label><div class="output-text"></div></div>
        <div class="form-group flex items-center"><label>Licence Plate</label><div class="output-text"></div></div>
        <div class="form-group flex items-center"><label>Odometer (km)</label><div class="output-text"></div></div>
        <div class="form-group flex items-center"><label>Date Inspected</label><div class="output-text"></div></div>
      </div>

      <div class="grid grid-cols-2 sm:grid-cols-4 gap-1 mb-1">
        <p class="text-xxs text-gray-500 italic col-span-2">
          An under-vehicle inspection is valid until the 31st day after it is conducted or until the motor coach has been driven 12,000 kilometres, whichever occurs last.
        </p>
        <div class="form-group flex items-center"><label>Odometer Expires</label><div class="output-text"></div></div>
        <div class="form-group flex items-center"><label>Date Expires</label><div class="output-text"></div></div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <!-- Left column -->
        <div>
          <h2 class="section-header my-1">1. Air Brake System</h2>
          <div class="grid grid-cols-1 gap-0.5">
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Audible air leak</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Brake pushrod stroke is at or beyond the adjustment limit</span></div>
            <div class="pl-4 mt-1">
              <h3 class="font-bold my-1 text-gray-800 text-xxs">Brake Pushrod Stroke Measurements</h3>
              <div class="flex flex-wrap gap-2">
                <div class="flex items-center"><label class="mr-1 text-xxs">R Steer</label><div class="output-text" style="width:45px;"></div></div>
                <div class="flex items-center"><label class="mr-1 text-xxs">R Drive</label><div class="output-text" style="width:45px;"></div></div>
                <div class="flex items-center"><label class="mr-1 text-xxs">R Tag</label><div class="output-text" style="width:45px;"></div></div>
              </div>
              <div class="flex flex-wrap gap-2 mt-1">
                <div class="flex items-center"><label class="mr-1 text-xxs">L Steer</label><div class="output-text" style="width:45px;"></div></div>
                <div class="flex items-center"><label class="mr-1 text-xxs">L Drive</label><div class="output-text" style="width:45px;"></div></div>
                <div class="flex items-center"><label class="mr-1 text-xxs">L Tag</label><div class="output-text" style="width:45px;"></div></div>
              </div>
            </div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Clearance between disc brake pads and rotor exceeds manufacturer's specified limit</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Wedge brake shoe movement exceeds manufacturer's specified limit</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Excessive discharge of fluids from air reservoir</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Air compressor, mounts or attachments damaged or defective</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Compressor drive belt loose or damaged</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Air line or fitting damaged or insecure</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Air tank defective, damaged or insecure</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Air tank drain or moisture ejector device inoperative</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Brake chamber, brake linkage or other brake component is defective, damaged or insecure</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Spring brake is broken or malfunctions</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Inoperative service, parking or emergency brake</span></div>
          </div>

          <h2 class="section-header my-1">2. Exhaust System</h2>
          <div class="grid grid-cols-1 gap-0.5">
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Exhaust leak</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Exhaust system component insecure, damaged or perforated</span></div>
          </div>

          <h2 class="section-header my-1">3. Frame and/or Underbody</h2>
          <div class="grid grid-cols-1 gap-0.5">
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Any frame member or fastener is damaged, cracked or insecure</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Any component mount is damaged or insecure</span></div>
          </div>
        </div>

        <!-- Right column -->
        <div>
          <h2 class="section-header my-1">4. Fuel System</h2>
          <div class="grid grid-cols-1 gap-0.5">
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Fuel leak</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Insecure fuel tanks, fuel tank mounts or guards</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Fuel line or fitting damaged or insecure</span></div>
          </div>

          <h2 class="section-header my-1">5. Steering</h2>
          <div class="grid grid-cols-1 gap-0.5">
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Steering linkage is damaged or insecure</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Power steering fluid is leaking, contaminated or low</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Power steering component damaged or insecure</span></div>
          </div>

          <h2 class="section-header my-1">6. Suspension System</h2>
          <div class="grid grid-cols-1 gap-0.5">
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Air leak or malfunction of air suspension system or component</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Damage or deterioration of any suspension component</span></div>
          </div>

          <h2 class="section-header my-1">7. Tires</h2>
          <div class="grid grid-cols-1 gap-0.5">
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Tire inflation less than required</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Tire treads worn to wear limits</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Damage to tread or sidewall of tire</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Retread or rebuilt tire is used on front axle</span></div>
          </div>

          <h2 class="section-header my-1">8. Wheels and Fasteners</h2>
          <div class="grid grid-cols-1 gap-0.5">
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Loose, missing, damaged or ineffective wheel fastener</span></div>
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">Damaged wheel or wheel component</span></div>
          </div>

          <h2 class="section-header my-1">For buses travelling to USA, per FMCSA Regulations, Part 396.3</h2>
          <div class="grid grid-cols-1 gap-0.5">
            <div class="checklist-item"><span class="checklist-status"></span><span class="checklist-item-text">All push-out windows, emergency doors, and emergency door marking lights inspected and found to be operating normally</span></div>
            <div class="form-group flex items-center"><label>Tire size:</label><div class="output-text"></div></div>
          </div>
        </div>
      </div>

      <div class="mt-2">
        <h2 class="section-header my-1">Repairs</h2>
        <div class="output-text"></div>
      </div>

      <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-1">
        <div class="form-group">
          <h2 class="section-header my-1">Name of the person who conducted the inspection (Printed)</h2>
          <div class="output-text"></div>
          <div class="text-xxs text-gray-700 leading-tight mt-1">
            I declare that the vehicle shown above has been inspected in accordance with this Regulation and that at the end of the inspection, there are no defects listed in Schedule 4. O. Reg. 199/07, s. 12 (1); O. Reg. 242/14, s. 6 (1-3); O. Reg. 256/15, s. 5 (1).
          </div>
        </div>
        <div class="form-group">
          <h2 class="section-header my-1">Signature of the person who conducted the inspection</h2>
          <div class="output-text p-1" style="height:100px;">
            <img id="signatureImg" alt="Signature" class="mx-auto block signature-img">
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  (async function () {
    function normalizeKey(s) {
      return String(s || '')
        .toLowerCase()
        .replace(/&/g, ' and ')
        .replace(/[^a-z0-9 ]+/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    }

    function setStatus(el, status) {
      const badge = el.querySelector('.checklist-status'); if (!badge) return;
      badge.className = 'checklist-status';
      const v = (status || '').toString().trim().toLowerCase();
      if (['pass','ok','✓','yes','y','good','normal'].includes(v)) { badge.textContent='✓'; badge.classList.add('status-pass'); }
      else if (['repair','repaired','r','fail','f','defect'].includes(v)) { badge.textContent='R'; badge.classList.add('status-repair'); }
      else if (['na','n/a','not applicable'].includes(v)) { badge.textContent='N/A'; badge.classList.add('status-na'); }
      else { badge.textContent = v || ''; }
    }

    function fillByLabel(labelText, value) {
      if (!value) return;
      const labels = [...document.querySelectorAll('label')];
      const label = labels.find(l => l.textContent.trim().toLowerCase() === labelText.toLowerCase());
      if (label) {
        const box = label.closest('.form-group,.flex')?.querySelector('.output-text');
        if (box) box.textContent = value;
      }
    }

    function fillTiny(lbl, val) {
      if (!val) return;
      const tiny = [...document.querySelectorAll('.pl-4 .flex.items-center')];
      const match = tiny.find(g => g.querySelector('label')?.textContent.trim().toLowerCase() === lbl.toLowerCase());
      const box = match?.querySelector('.output-text');
      if (box) box.textContent = val;
    }

    function applyData(data) {
      fillByLabel('Carrier', data.carrierName);
      fillByLabel('Address of the location where the inspection is conducted', data.locationAddress);
      fillByLabel('Unit #', data.unitNumber);
      fillByLabel('Licence Plate', data.licensePlate);
      fillByLabel('Odometer (km)', data.odometer);
      fillByLabel('Date Inspected', data.inspectionDate);
      fillByLabel('Odometer Expires', data.odometerExpires);
      fillByLabel('Date Expires', data.dateExpires);
      fillByLabel('Tire size:', data.tireSize);

      fillTiny('r steer', data.rSteerBrake);
      fillTiny('r drive', data.rDriveBrake);
      fillTiny('r tag', data.rTagBrake);
      fillTiny('l steer', data.lSteerBrake);
      fillTiny('l drive', data.lDriveBrake);
      fillTiny('l tag', data.lTagBrake);

      const repHdr = [...document.querySelectorAll('.section-header')].find(h=>h.textContent.trim().toLowerCase()==='repairs');
      if (repHdr) { const box = repHdr.parentElement.querySelector('.output-text'); if (box && data.repairs) box.textContent = data.repairs; }

      const inspHdr = [...document.querySelectorAll('.section-header')].find(h=>h.textContent.toLowerCase().includes('name of the person'));
      if (inspHdr) { const box = inspHdr.parentElement.querySelector('.output-text'); if (box && data.inspectorName) box.textContent = data.inspectorName; }

      if (data.signature) { const img = document.getElementById('signatureImg'); if (img) img.src = data.signature; }

      const inMap = {};
      const rawCL = data.checklist || {};
      Object.keys(rawCL).forEach(k => { inMap[normalizeKey(k)] = rawCL[k]; });

      document.querySelectorAll('.checklist-item').forEach(item => {
        const label = item.querySelector('.checklist-item-text')?.textContent.trim() || '';
        const norm = normalizeKey(label);
        const v = inMap[norm] ?? rawCL[label];
        if (v != null) setStatus(item, v);
      });
    }

    async function loadFromServerById(id) {
      const res = await fetch('/api/schedule4s/get?id=' + encodeURIComponent(id), { credentials:'include', cache: 'no-store' });
      if (!res.ok) throw new Error('fetch failed');
      const j = await res.json();
      const row = j.item || j || {};
      const p = row.payload_json || row.payload || {};
      const checklist = p.checklist || {};

      function pick() {
        for (let i=0;i<arguments.length;i++) {
          const k = arguments[i];
          if (p && p[k] != null && p[k] !== '') return p[k];
        }
        return '';
      }

      const data = {
        carrierName     : pick('carrierName','carrier'),
        locationAddress : pick('locationAddress','address','inspectionLocation'),
        unitNumber      : pick('unitNumber','unit','vehicle_number') || row.vehicle_name || '',
        licensePlate    : pick('licensePlate','licencePlate','plate'),
        odometer        : pick('odometer','odometerKm','odometer_km'),
        inspectionDate  : pick('inspectionDate') || row.performed_at || row.created_at || '',
        odometerExpires : pick('odometerExpires'),
        dateExpires     : pick('dateExpires') || row.expiry_date || '',
        tireSize        : pick('tireSize'),
        repairs         : pick('repairs','repairsNotes','repairs_text'),
        inspectorName   : pick('inspectorName') || row.technician_name || '',
        signature       : pick('signature'),
        rSteerBrake     : pick('rSteerBrake','r_steer_brake','rSteer'),
        rDriveBrake     : pick('rDriveBrake','r_drive_brake','rDrive'),
        rTagBrake       : pick('rTagBrake','r_tag_brake','rTag'),
        lSteerBrake     : pick('lSteerBrake','l_steer_brake','lSteer'),
        lDriveBrake     : pick('lDriveBrake','l_drive_brake','lDrive'),
        lTagBrake       : pick('lTagBrake','l_tag_brake','lTag'),
        checklist       : checklist
      };
      try { sessionStorage.setItem('schedule4Data', JSON.stringify(data)); } catch(e){}
      try { sessionStorage.setItem('schedule4LoadedFromId','1'); } catch(e){}
      return data;
    }

    const params = new URLSearchParams(location.search);
    const id = params.get('id') || params.get('inspectionId') || params.get('schedule4Id');

    let data = {};
    if (id) {
      try { data = await loadFromServerById(id); }
      catch(e) { /* leave blank if fetch fails */ }
    } else {
      try { const ss = sessionStorage.getItem('schedule4Data'); if (ss) data = JSON.parse(ss) || {}; } catch(e){}
      const keys = [
        'carrierName','locationAddress','unitNumber','licensePlate','odometer','inspectionDate',
        'odometerExpires','dateExpires','rSteerBrake','rDriveBrake','rTagBrake','lSteerBrake','lDriveBrake','lTagBrake',
        'tireSize','repairs','inspectorName','signature'
      ];
      for (const k of keys) if (!(k in data) && params.has(k)) data[k] = params.get(k);
      data.checklist = data.checklist || {};
    }

    applyData(data);

    window.addEventListener('pageshow', function(e){ if (e.persisted) location.reload(); });
  })();
  </script>

  <script>
  // Fallback save to DB if first attempt was missed
  document.addEventListener('DOMContentLoaded', () => {
    try { if (sessionStorage.getItem('schedule4LoadedFromId') === '1') return; } catch(e) {}
    try {
      const raw = sessionStorage.getItem('schedule4Data');
      if (!raw) return;
      const payload = JSON.parse(raw);
      const jsonBody = JSON.stringify({ payload });
      fetch('/api/inspections', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: jsonBody,
        keepalive: true
      }).catch(() => {});
    } catch (e) {}
  });
  </script>

  <script>
    async function downloadServerPDF() {
      try {
        const data = JSON.parse(sessionStorage.getItem('schedule4Data') || '{}');
        const res = await fetch('/api/pdf/print', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path: '/output.html', data, filename: 'Schedule-4-Inspection.pdf' })
        });
        if (!res.ok) throw new Error(await res.text());
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'Schedule-4-Inspection.pdf';
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      } catch (err) { alert('Server PDF failed: ' + err.message); }
    }
  </script>

</body>
</html>
