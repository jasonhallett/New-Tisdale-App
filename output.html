<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TBL Internal App - View Schedule 4 Inspection</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    html, body { margin:0; padding:0; background:#ffffff; font-family:'Inter',sans-serif; }
    :root { --page-w: 816px; --page-h: 1056px; }

    #page { width: var(--page-w); min-height: var(--page-h); margin: 0 auto; background: #ffffff; }
    .content { padding: 12px; }

    .section-header { font-size: 0.75rem; font-weight: 600; color: #1f2937; margin-bottom: 0.25rem; }
    .form-group label { font-weight: 500; font-size: 0.75rem; color: #111827; display:block; }
    .output-text { min-height: 1.5rem; font-size: 0.875rem; padding: 0.25rem 0.5rem; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 6px; }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; }
    .grid-6 { display: grid; grid-template-columns: repeat(6, minmax(0, 1fr)); gap: 0.25rem; }
    .row { display:flex; align-items:center; gap:8px; }
    .label-sm { font-size: 0.75rem; color:#111827; }
    .tiny-label { font-size: 0.625rem; color:#111827; }

    .checklist-group { margin-top: 4px; }
    .checklist-item { display: flex; align-items: center; background: #fcfcfc; border-radius: 8px; border: 1px solid #e5e7eb; margin-bottom: 0.025rem; }
    .checklist-item-text { font-size: 0.625rem; color: #374151; }
    .checklist-status { font-weight: 600; font-size: 0.625rem; padding: 0.1rem 0.6rem; border-radius: 4px; margin-right: 0.25rem; }
    .status-pass { color: #166534; background-color: #dcfce7; }
    .status-repair { color: #991b1b; background-color: #fee2e2; }
    .status-na { color: #4b5563; background-color: #e5e7eb; }

    .text-xxs { font-size: 0.5rem; }
    .signature-img { width: 400px; height: 100px; border: 1px solid #e5e7eb; object-fit: contain; }


    @page { size: 8.5in 11in; margin: 0; }
    @media print {
      html, body { width:8.5in; height:11in; margin:0; padding:0; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
      #page { width:8.5in !important; min-height:11in !important; margin:0 !important; }
      .no-print { display:none !important; }
    }
  </style>

  <!-- Preload Schedule 4 by ID so existing script can populate -->
  <script>
  (function () {
    try {
      var params = new URLSearchParams(location.search);
      var id = params.get('id') || params.get('inspectionId') || params.get('schedule4Id');
      if (!id) return; // open-from-submit path stays unchanged

      // Prevent double-load if opener already set data
      try { if (sessionStorage.getItem('schedule4LoadedFromId') === '1') return; } catch(e) {}

      var xhr = new XMLHttpRequest();
      xhr.open('GET', '/api/schedule4s/get?id=' + encodeURIComponent(id), false); // sync ensures data is ready
      xhr.setRequestHeader('Accept', 'application/json');
      xhr.send(null);

      if (xhr.status >= 200 && xhr.status < 300) {
        var resp = {};
        try { resp = JSON.parse(xhr.responseText) || {}; } catch(e){ resp = {}; }
        var row = resp.item || resp || {};
        var p = row.payload_json || row.payload || {};

        var data = {};
        // Fields your page already reads
        data.carrierName     = p.carrierName || '';
        data.locationAddress = p.locationAddress || '';
        data.unitNumber      = p.unitNumber || row.vehicle_name || '';
        data.licensePlate    = p.licensePlate || row.license_plate || '';
        data.odometer        = p.odometer || p.odometerKm || row.odometer_km || '';
        data.inspectionDate  = p.inspectionDate || row.performed_at || row.created_at || '';
        data.odometerExpires = p.odometerExpires || '';
        data.dateExpires     = p.dateExpires || row.expiry_date || '';
        data.tireSize        = p.tireSize || '';
        data.repairs         = p.repairs || '';
        data.inspectorName   = p.inspectorName || row.technician_name || '';
        data.signature       = p.signature || '';

        // Brake Pushrod Stroke Measurements (exact keys your script expects)
        data.rSteerBrake = p.rSteerBrake || '';
        data.rDriveBrake = p.rDriveBrake || '';
        data.rTagBrake   = p.rTagBrake   || '';
        data.lSteerBrake = p.lSteerBrake || '';
        data.lDriveBrake = p.lDriveBrake || '';
        data.lTagBrake   = p.lTagBrake   || '';

        // Checklist normalization: convert '&&' → 'and' to match DOM labels
        var cl = p.checklist || {};
        var normalized = {};
        try {
          Object.keys(cl).forEach(function(k){
            var nk = String(k).replace(/\s*&&\s*/g, ' and ').replace(/\s+/g, ' ').trim();
            normalized[nk] = cl[k];
          });
        } catch(e) {}
        data.checklist = normalized;

        try { sessionStorage.setItem('schedule4Data', JSON.stringify(data)); } catch(e){}
        try { sessionStorage.setItem('schedule4LoadedFromId', '1'); } catch(e){}
      }
    } catch (e) { /* swallow */ }
  })();
  </script>

</head>
<body>
  <div class="no-print p-2 flex items-center justify-between border-b">
    <div class="flex items-center gap-2">
      <button onclick="window.print()" class="px-3 py-1.5 border rounded">Print</button>
      <button id="downloadServer" class="px-3 py-1.5 border rounded">Download PDF</button>
    </div>
    <div class="text-sm text-gray-700">Completed Motor Coach Under-Vehicle Inspection Report</div>
  </div>

  <div id="page">
    <div class="content">
      <div class="grid-3 gap-2">
        <div class="form-group">
          <h2 class="section-header my-1">Carrier</h2>
          <div class="output-text"></div>
        </div>
        <div class="form-group">
          <h2 class="section-header my-1">Address of the location where the inspection is conducted</h2>
          <div class="output-text"></div>
        </div>
        <div class="form-group">
          <h2 class="section-header my-1">Unit #</h2>
          <div class="output-text"></div>
        </div>
        <div class="form-group">
          <h2 class="section-header my-1">Licence Plate</h2>
          <div class="output-text"></div>
        </div>
        <div class="form-group">
          <h2 class="section-header my-1">Odometer (km)</h2>
          <div class="output-text"></div>
        </div>
        <div class="form-group">
          <h2 class="section-header my-1">Date Inspected</h2>
          <div class="output-text"></div>
        </div>
        <div class="form-group">
          <h2 class="section-header my-1">Odometer Expires</h2>
          <div class="output-text"></div>
        </div>
        <div class="form-group">
          <h2 class="section-header my-1">Date Expires</h2>
          <div class="output-text"></div>
        </div>
        <div class="form-group">
          <h2 class="section-header my-1">Tire size:</h2>
          <div class="output-text"></div>
        </div>
      </div>

      <div class="mt-2">
        <h2 class="section-header">Brake Pushrod Stroke Measurements</h2>
        <div class="pl-4">
          <div class="flex items-center gap-2 my-0.5"><label class="tiny-label">R Steer</label><div class="output-text flex-1"></div></div>
          <div class="flex items-center gap-2 my-0.5"><label class="tiny-label">R Drive</label><div class="output-text flex-1"></div></div>
          <div class="flex items-center gap-2 my-0.5"><label class="tiny-label">R Tag</label><div class="output-text flex-1"></div></div>
          <div class="flex items-center gap-2 my-0.5"><label class="tiny-label">L Steer</label><div class="output-text flex-1"></div></div>
          <div class="flex items-center gap-2 my-0.5"><label class="tiny-label">L Drive</label><div class="output-text flex-1"></div></div>
          <div class="flex items-center gap-2 my-0.5"><label class="tiny-label">L Tag</label><div class="output-text flex-1"></div></div>
        </div>
      </div>

      <!-- (Checklist markup preserved — trimmed here for brevity in this snippet) -->
      <!-- … all your existing checklist items … -->

      <div class="grid-2 gap-2 mt-2">
        <div class="form-group">
          <h2 class="section-header my-1">Name of the person who conducted the inspection (Printed)</h2>
          <div class="output-text"></div>
          <div class="text-xxs text-gray-700 leading-tight mt-1">
            I declare that the vehicle shown above has been made roadworthy by me or that, on my inspection, there are no defects listed in Schedule 4. O. Reg. 199/07, s. 12 (1).
          </div>
        </div>
        <div class="form-group">
          <h2 class="section-header my-1">Signature of the person who conducted the inspection</h2>
          <div class="output-text p-1" style="height:100px;">
            <img id="signatureImg" alt="Signature" class="mx-auto block signature-img">
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      function getData() {
        let data = {};
        try { const ss = sessionStorage.getItem('schedule4Data'); if (ss) data = JSON.parse(ss) || {}; } catch(e){}
        const params = new URLSearchParams(location.search);
        const keys = [
          'carrierName','locationAddress','unitNumber','licensePlate','odometer','inspectionDate',
          'odometerExpires','dateExpires','rSteerBrake','rDriveBrake','rTagBrake','lSteerBrake','lDriveBrake','lTagBrake',
          'tireSize','repairs','inspectorName','signature'
        ];
        for (const k of keys) if (!(k in data) && params.has(k)) data[k] = params.get(k);
        data.checklist = data.checklist || {};
        return data;
      }
      const data = getData();

      function fillByLabel(labelText, value) {
        if (!value) return;
        const labels = [...document.querySelectorAll('label')];
        const label = labels.find(l => l.textContent.trim().toLowerCase() === labelText.toLowerCase());
        if (label) {
          const box = label.closest('.form-group,.flex')?.querySelector('.output-text');
          if (box) box.textContent = value;
        }
      }
      fillByLabel('Carrier', data.carrierName);
      fillByLabel('Address of the location where the inspection is conducted', data.locationAddress);
      fillByLabel('Unit #', data.unitNumber);
      fillByLabel('Licence Plate', data.licensePlate);
      fillByLabel('Odometer (km)', data.odometer);
      fillByLabel('Date Inspected', data.inspectionDate);
      fillByLabel('Odometer Expires', data.odometerExpires);
      fillByLabel('Date Expires', data.dateExpires);
      fillByLabel('Tire size:', data.tireSize);

      function fillTiny(lbl, val) {
        if (!val) return;
        const tiny = [...document.querySelectorAll('.pl-4 .flex.items-center')];
        const match = tiny.find(g => g.querySelector('label')?.textContent.trim().toLowerCase() === lbl.toLowerCase());
        const box = match?.querySelector('.output-text');
        if (box) box.textContent = val;
      }
      fillTiny('r steer', data.rSteerBrake);
      fillTiny('r drive', data.rDriveBrake);
      fillTiny('r tag', data.rTagBrake);
      fillTiny('l steer', data.lSteerBrake);
      fillTiny('l drive', data.lDriveBrake);
      fillTiny('l tag', data.lTagBrake);

      const repHdr = [...document.querySelectorAll('.section-header')].find(h=>h.textContent.trim().toLowerCase()==='repairs');
      if (repHdr) { const box = repHdr.parentElement.querySelector('.output-text'); if (box && data.repairs) box.textContent = data.repairs; }

      const inspHdr = [...document.querySelectorAll('.section-header')].find(h=>h.textContent.toLowerCase().includes('name of the person'));
      if (inspHdr) { const box = inspHdr.parentElement.querySelector('.output-text'); if (box && data.inspectorName) box.textContent = data.inspectorName; }

      if (data.signature) { const img = document.getElementById('signatureImg'); if (img) img.src = data.signature; }

      function setStatus(el, status) {
        const badge = el.querySelector('.checklist-status'); if (!badge) return;
        badge.className = 'checklist-status';
        if (['pass','ok','✓','yes','y'].includes((status||'').toString().trim().toLowerCase())) { badge.textContent='✓'; badge.classList.add('status-pass'); }
        else if (['repair','repaired','r','fail','f'].includes((status||'').toString().trim().toLowerCase())) { badge.textContent='R'; badge.classList.add('status-repair'); }
        else if (['na','n/a','not applicable'].includes((status||'').toString().trim().toLowerCase())) { badge.textContent='N/A'; badge.classList.add('status-na'); }
      }
      document.querySelectorAll('.checklist-item').forEach(item => {
        const label = item.querySelector('.checklist-item-text')?.textContent.trim();
        if (label && data.checklist[label]) setStatus(item, data.checklist[label]);
      });
    })();
  </script>

  <script>
  // Fallback save to DB if first attempt was missed
  document.addEventListener('DOMContentLoaded', () => {
    try {
      const raw = sessionStorage.getItem('schedule4Data');
      if (!raw) return;
      const payload = JSON.parse(raw);
      const jsonBody = JSON.stringify({ payload });
      fetch('/api/inspections', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: jsonBody,
        keepalive: true
      }).catch(() => {});
    } catch (e) {}
  });
  </script>

  <script>
    // Server PDF generator
    async function downloadServerPDF() {
      try {
        const data = JSON.parse(sessionStorage.getItem('schedule4Data') || '{}');
        const res = await fetch('/api/pdf/print', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ path: '/output.html', data, filename: 'Schedule-4-Inspection.pdf' })
        });
        if (!res.ok) throw new Error(await res.text());
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'Schedule-4-Inspection.pdf';
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      } catch (err) { alert('Server PDF failed: ' + err.message); }
    }
    document.getElementById('downloadServer').addEventListener('click', downloadServerPDF);
  </script>
</body>
</html>
