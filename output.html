<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TBL Internal App - View Schedule 4 Inspection</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    html, body { margin:0; padding:0; background:#ffffff; font-family:'Inter',sans-serif; }
    :root { --page-w: 816px; --page-h: 1056px; }

    #page { width: var(--page-w); min-height: var(--page-h); margin: 0 auto; background: #ffffff; }
    .content { padding: 12px; }

    .section-header { font-size: 0.75rem; font-weight: 600; color: #1f2937; margin-bottom: 0.25rem; }
    .form-group label { font-weight: 500; color: #374151; font-size: 0.625rem; }
    .output-text { width: 100%; padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.625rem; background-color: #f9fafb; color: #1f2937; flex: 1; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    .grid-6 { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; }
    .row { display: flex; gap: 8px; align-items: center; }
    .label-col { width: 180px; flex: 0 0 180px; }
    .value-col { flex: 1; }

    .check-grid { display:grid; grid-template-columns: 1fr 72px 72px 72px; gap:6px; align-items:center; }
    .check-grid .head { font-size: 0.7rem; font-weight:600; color:#111827; padding: 2px 0; }
    .check-grid .cell { font-size: 0.65rem; color:#111827; background:#f9fafb; border-radius:4px; padding:4px 6px; text-align:center; }

    .title { font-size: 0.9rem; font-weight: 700; color: #111827; margin-bottom: 4px; }
    .subtle { color: #6b7280; }

    .print-actions { display:flex; justify-content:flex-end; gap:8px; padding:8px 12px; max-width: var(--page-w); margin: 0 auto; }
    .btn { display:inline-flex; align-items:center; gap:6px; border:1px solid rgba(0,0,0,0.1); padding:8px 10px; border-radius:8px; background:#fff; font-size:0.8rem; }
    .btn:hover { background:#f3f4f6; }

    @media print {
      .print-actions { display:none; }
      html, body { background:#fff; }
      #page { box-shadow:none; }
    }
  </style>

  <!-- Preload data by ID (runs before population script) -->
  <script>
  (function () {
    try {
      var params = new URLSearchParams(location.search);
      var id = params.get('id') || params.get('inspectionId') || params.get('schedule4Id');
      if (!id) return;
      // always fetch fresh when id is present; previously returned if schedule4LoadedFromId=1
      var xhr = new XMLHttpRequest();
      xhr.open('GET', '/api/schedule4s/get?id=' + encodeURIComponent(id), false); // sync on purpose
      xhr.setRequestHeader('Accept','application/json');
      xhr.send(null);
      if (xhr.status >= 200 && xhr.status < 300) {
        var resp = {};
        try { resp = JSON.parse(xhr.responseText) || {}; } catch(e){ resp = {}; }
        var row = resp.item || resp || {};

        var p = row.payload_json || row.payload || {};
        function pick() {
          for (var i = 0; i < arguments.length; i++) {
            var k = arguments[i];
            if (p && p[k] != null && p[k] !== '') return p[k];
          }
          return '';
        }

        var data = {};
        data.carrierName     = pick('carrierName','carrier');
        /* include your DB column 'location' so address shows correctly */
        data.locationAddress = pick('location','locationAddress','address','inspectionLocation');
        data.unitNumber      = pick('unitNumber','unit','vehicle_number') || row.vehicle_name || '';
        data.licensePlate    = pick('licensePlate','licencePlate','plate');
        data.odometer        = pick('odometer','odometerKm','odometer_km');
        data.inspectionDate  = pick('inspectionDate') || row.performed_at || row.created_at || '';
        data.odometerExpires = pick('odometerExpires');
        data.dateExpires     = pick('dateExpires') || row.expiry_date || '';
        data.tireSize        = pick('tireSize');
        data.repairs         = pick('repairs','repairsNotes','repairs_text');
        data.inspectorName   = pick('inspectorName') || row.technician_name || '';
        data.signature       = pick('signature');
        data.checklist       = p.checklist || {};

        try { sessionStorage.setItem('schedule4Data', JSON.stringify(data)); } catch(e){}
        try { sessionStorage.setItem('schedule4LoadedFromId','1'); } catch(e){}
      }
    } catch (e) {}
  })();
  </script>

</head>
<body>
  <!-- Buttons -->
  <div class="print-actions">
    <button class="btn" id="backBtn" title="Back">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
      Back
    </button>
    <button class="btn" id="printBtn" title="Print / Save PDF">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
      Print / Save PDF
    </button>
  </div>

  <!-- One-page canvas -->
  <div id="page">
    <div class="content">

      <div class="title">Completed Motor Coach Under-Vehicle Inspection Report</div>
      <div class="subtle" id="subtitle"></div>

      <div class="grid-2" style="margin-top: 6px;">
        <div class="form-group row">
          <label class="label-col">Carrier Name</label>
          <div class="value-col"><div class="output-text" id="carrierName"></div></div>
        </div>
        <div class="form-group row">
          <label class="label-col">Location Address</label>
          <div class="value-col"><div class="output-text" id="locationAddress"></div></div>
        </div>
      </div>

      <div class="grid-3">
        <div class="form-group row">
          <label class="label-col">Unit #</label>
          <div class="value-col"><div class="output-text" id="unitNumber"></div></div>
        </div>
        <div class="form-group row">
          <label class="label-col">License Plate</label>
          <div class="value-col"><div class="output-text" id="licensePlate"></div></div>
        </div>
        <div class="form-group row">
          <label class="label-col">Odometer</label>
          <div class="value-col"><div class="output-text" id="odometer"></div></div>
        </div>
      </div>

      <div class="grid-3">
        <div class="form-group row">
          <label class="label-col">Date Inspected</label>
          <div class="value-col"><div class="output-text" id="inspectionDate"></div></div>
        </div>
        <div class="form-group row">
          <label class="label-col">Odometer Expires</label>
          <div class="value-col"><div class="output-text" id="odometerExpires"></div></div>
        </div>
        <div class="form-group row">
          <label class="label-col">Date Expires</label>
          <div class="value-col"><div class="output-text" id="dateExpires"></div></div>
        </div>
      </div>

      <!-- (the rest of your existing output layout and checklist rendering remains unchanged) -->

      <div class="section-header" style="margin-top:10px">Technician</div>
      <div class="grid-2">
        <div class="form-group row">
          <label class="label-col">Inspector Name</label>
          <div class="value-col"><div class="output-text" id="inspectorName"></div></div>
        </div>
        <div class="form-group row">
          <label class="label-col">Signature</label>
          <div class="value-col"><img id="signature" alt="Signature" style="max-height:80px; max-width:100%"/></div>
        </div>
      </div>

      <!-- Checklist (unchanged markup) -->
      <div class="section-header" style="margin-top:10px">Checklist</div>
      <div class="check-grid" id="checkGrid">
        <div class="head">Item</div>
        <div class="head">✓</div>
        <div class="head">R</div>
        <div class="head">N/A</div>
        <!-- cells populated by JS -->
      </div>

    </div>
  </div>

  <script>
    function toUSDateString(date) {
      try {
        if (!date) return '';
        var d = new Date(date);
        if (isNaN(+d)) { // already mm/dd/yyyy?
          var m = String(date).match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})/);
          if (m) return [m[1].padStart(2,'0'), m[2].padStart(2,'0'), m[3]].join('/');
          return '';
        }
        var mm = String(d.getMonth()+1).padStart(2,'0');
        var dd = String(d.getDate()).padStart(2,'0');
        var yy = d.getFullYear();
        return mm+'/'+dd+'/'+yy;
      } catch(e){ return ''; }
    }
    function fromUSDate(s) {
      var m = String(s||'').match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
      if (!m) return null;
      return new Date(+m[3], +m[1]-1, +m[2]);
    }
    function addDays(d, days) {
      var x = new Date(d.getTime());
      x.setDate(x.getDate()+days);
      return x;
    }
    function fmtOdo(v) {
      if (v == null || v === '') return '';
      var n = Number(String(v).replace(/[^0-9.]/g,'')); if (!isFinite(n)) return '';
      return Math.round(n).toLocaleString('en-CA');
    }

    // Build checklist UI
    function buildChecklist(check) {
      var g = document.getElementById('checkGrid');
      function row(label, key) {
        var v = (check && check[key]) || {};
        var ok = v.ok ? '✓' : '';
        var rep = v.rep ? 'R' : '';
        var na = v.na ? 'N/A' : '';
        var div1 = document.createElement('div'); div1.textContent = label; div1.className = 'cell';
        var div2 = document.createElement('div'); div2.textContent = ok;   div2.className = 'cell';
        var div3 = document.createElement('div'); div3.textContent = rep;  div3.className = 'cell';
        var div4 = document.createElement('div'); div4.textContent = na;   div4.className = 'cell';
        g.appendChild(div1); g.appendChild(div2); g.appendChild(div3); g.appendChild(div4);
      }
      // (rows added as before…)
      var items = [
        ['Pushrod travel within limit','pushrodWithin'],
        ['Brake components secure','brakeSecure'],
        ['Brake hose/tubing free of kinks','hoseKinks'],
        ['Slack adjusters working','slackAdjusters'],
        ['Steering linkage secure','steeringLinkage'],
        ['Suspension components normal','suspension'],
        ['Air leaks','airLeaks'],
        ['Tires condition','tires'],
        ['Wheels secure','wheels'],
        ['Lights and reflectors','lights'],
        ['Emergency exits working','emergencyExits'],
        ['Door/Marking lights working','doorMarkingLights'],
      ];
      for (var i=0;i<items.length;i++) row(items[i][0], items[i][1]);
    }

    // Populate from cached/session values and URL params
    function getData() {
      var data = {};
      try { var ss = sessionStorage.getItem('schedule4Data'); if (ss) data = JSON.parse(ss) || {}; } catch(e){}
      var params = new URLSearchParams(location.search);
      var keys = [
        'carrierName','locationAddress','unitNumber','licensePlate','odometer','inspectionDate',
        'odometerExpires','dateExpires','rSteerBrake','rDriveBrake','rTagBrake','lSteerBrake','lDriveBrake','lTagBrake',
        'tireSize','repairs','inspectorName','signature'
      ];
      for (var i=0;i<keys.length;i++){ var k = keys[i]; if (!(k in data) && params.has(k)) data[k] = params.get(k); }
      data.checklist = data.checklist || {};

      // Normalize dates to mm/dd/yyyy for display
      var inspUS = toUSDateString(data.inspectionDate);
      data.inspectionDate = inspUS;

      // Odometer thousands
      data.odometer = fmtOdo(data.odometer);

      // Expiry dates handling
      var odoExp = toUSDateString(data.odometerExpires);
      data.odometerExpires = odoExp;

      var expUS = toUSDateString(data.dateExpires);
      if (!expUS) {
        // Fallback: compute +31 days from Inspection Date if Date Expires missing
        var d = fromUSDate(inspUS);
        if (d) expUS = toUSDateString(addDays(d, 31));
      }
      data.dateExpires = expUS;

      return data;
    }
    var data = getData();

    // --- Fill simple fields by label ---
    function fillByLabel(labelText, value) {
      if (value == null || value === '') return;
      var labels = Array.prototype.slice.call(document.querySelectorAll('label'));
      var label = labels.find(function(l){ return l.textContent.trim() === labelText; });
      if (!label) return;
      var targetId = label.getAttribute('for');
      if (!targetId) return;
      var el = document.getElementById(targetId);
      if (!el) return;
      if (el.tagName === 'IMG') {
        el.src = value;
      } else {
        el.textContent = value;
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Fill header subtitle
      var sub = [];
      if (data.unitNumber) sub.push('Unit ' + data.unitNumber);
      if (data.licensePlate) sub.push('Plate ' + data.licensePlate);
      if (data.inspectionDate) sub.push('Inspected ' + data.inspectionDate);
      document.getElementById('subtitle').textContent = sub.join(' • ');

      fillByLabel('Carrier Name', data.carrierName);
      fillByLabel('Location Address', data.locationAddress);
      fillByLabel('Unit #', data.unitNumber);
      fillByLabel('License Plate', data.licensePlate);
      fillByLabel('Odometer', data.odometer);
      fillByLabel('Date Inspected', data.inspectionDate);
      fillByLabel('Odometer Expires', data.odometerExpires);
      fillByLabel('Date Expires', data.dateExpires);
      fillByLabel('Inspector Name', data.inspectorName);
      fillByLabel('Signature', data.signature);

      buildChecklist(data.checklist);
    });

    // Print
    document.getElementById('printBtn').addEventListener('click', function() {
      window.print();
    });

    // Back
    document.getElementById('backBtn').addEventListener('click', function() {
      history.back();
    });
  </script>

  <!-- Fallback save to DB if first attempt was missed (no UI change) -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    try { if (sessionStorage.getItem('schedule4LoadedFromId') === '1') return; } catch(e) {}
    try {
      const raw = sessionStorage.getItem('schedule4Data');
      if (!raw) return;
      const payload = JSON.parse(raw);
      fetch('/api/inspections', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).catch(()=>{});
    } catch(e){}
  });
  </script>

</body>
</html>
